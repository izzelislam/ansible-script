- name: Install required packages
  apt:
    name:
      - ca-certificates
      - apt-transport-https
      - curl
      - gnupg
      - lsb-release
    state: present
    update_cache: yes

- name: Add Sury PHP GPG key
  shell: |
    curl -fsSL https://packages.sury.org/php/apt.gpg | gpg --dearmor -o /usr/share/keyrings/sury-php.gpg
  args:
    creates: /usr/share/keyrings/sury-php.gpg

- name: Add Sury PHP repository
  apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/sury-php.gpg] https://packages.sury.org/php/ {{ ansible_distribution_release }} main"
    state: present
    filename: sury-php
    update_cache: yes

- name: Install PHP 8.3 and extensions
  apt:
    name:
      - php8.3-fpm
      - php8.3-cli
      - php8.3-mysql
      - php8.3-xml
      - php8.3-mbstring
      - php8.3-zip
      - php8.3-curl
      - php8.3-gd
      - php8.3-bcmath
      - php8.3-intl
      - php8.3-opcache
    state: present

- name: Enable and start PHP 8.3 FPM
  systemd:
    name: php8.3-fpm
    enabled: true
    state: started
